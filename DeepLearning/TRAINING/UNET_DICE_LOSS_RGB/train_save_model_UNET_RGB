clear; clc; close all;

rootFolder='D:/DeepLearning';
numFolds=10;
classNames=["background","wound"];
labelIDs=[1 2];
inputSize=[128 128 3];
maxEpochs=50;
initialLearnRate=1e-4;

modelsRoot=fullfile(rootFolder,'MODELS','UNET_DICE_LOSS_RGB');
if ~isfolder(modelsRoot)
    mkdir(modelsRoot);
end

fprintf('Models will be saved in: %s\n',modelsRoot);

for foldNum=1:numFolds
    fprintf('\nProcessing Fold %d...\n',foldNum);
    trainingFoldNames=setdiff(1:numFolds,foldNum);
    testFoldName=foldNum;

    trainFoldNamesCell=arrayfun(@(x)sprintf('Fold%d',x),trainingFoldNames,'UniformOutput',false);
    [imdsTrainResized,pxdsTrainResized]=prepareFoldData(trainFoldNamesCell,inputSize,classNames,labelIDs,rootFolder);
    [imdsTestResized,pxdsTestResized]=prepareFoldData({sprintf('Fold%d',testFoldName)},inputSize,classNames,labelIDs,rootFolder); 

    trainingData=pixelLabelImageDatastore(imdsTrainResized,pxdsTrainResized);

    lgraph=unetLayers(inputSize,numel(classNames));
    diceLayer=diceLossLayer('Dice-Loss');
    lgraph=replaceLayer(lgraph,'Segmentation-Layer',diceLayer);
    analyzeNetwork(lgraph);

    options=trainingOptions('adam', ...
        'InitialLearnRate',initialLearnRate, ...
        'MaxEpochs',maxEpochs, ...
        'MiniBatchSize',8, ...
        'Shuffle','every-epoch', ...
        'Plots','training-progress', ...
        'VerboseFrequency',10);

    try
        fprintf('Starting training for Fold %d...\n',foldNum);
        [net,info]=trainNetwork(trainingData,lgraph,options);

        foldModelName=fullfile(modelsRoot,sprintf('unet_dice_loss_fold_%d.mat',foldNum));
        save(foldModelName,'net','info');
        fprintf('Model for Fold %d saved as %s\n',foldNum,foldModelName);
    catch ME
        fprintf('Training interrupted in Fold %d!\n',foldNum);
        if exist('net','var')
            foldPartialModelName=fullfile(modelsRoot,sprintf('unet_dice_loss_fold_%d_partial.mat',foldNum));
            save(foldPartialModelName,'net','info');
            fprintf('Partially trained model for Fold %d saved as %s\n',foldNum,foldPartialModelName);
        end
        rethrow(ME);
    end
end

function [imdsResized,pxdsResized]=prepareFoldData(foldNames,inputSize,classNames,labelIDs,rootFolder)
    images={};
    labels={};
    for i=1:numel(foldNames)
        foldPath=fullfile(rootFolder,foldNames{i});
        caseDirs=dir(fullfile(foldPath,'case_*'));
        for j=1:numel(caseDirs)
            casePath=fullfile(foldPath,caseDirs(j).name);
            imageFiles=dir(fullfile(casePath,'*_rgb.png'));
            labelFiles=dir(fullfile(casePath,'*_gt.png'));
            if ~isempty(imageFiles) && ~isempty(labelFiles)
                imagePaths=fullfile({imageFiles.folder},{imageFiles.name});
                labelPaths=fullfile({labelFiles.folder},{labelFiles.name});
                images=[images;imagePaths(:)];
                labels=[labels;labelPaths(:)];
            end
        end
    end
    [imagesSynced,labelsSynced]=synchronizeDatasets(images,labels,'_rgb','_gt');
    resizedImages=cellfun(@(x)ensureRGB(imresize(imread(x),inputSize(1:2))),imagesSynced,'UniformOutput',false);
    resizedMasks=cellfun(@(x)uint8(imresize(imread(x),inputSize(1:2),'nearest')),labelsSynced,'UniformOutput',false);

    tempImageDir=tempname;
    tempLabelDir=tempname;
    mkdir(tempImageDir);
    mkdir(tempLabelDir);
    for i=1:numel(resizedImages)
        imwrite(resizedImages{i},fullfile(tempImageDir,sprintf('image_%d.png',i)));
        imwrite(resizedMasks{i},fullfile(tempLabelDir,sprintf('label_%d.png',i)));
    end
    imdsResized=imageDatastore(tempImageDir);
    pxdsResized=pixelLabelDatastore(tempLabelDir,classNames,labelIDs);
end

function [syncedImages,syncedLabels]=synchronizeDatasets(images,labels,suffixImage,suffixLabel)
    [~,imageNames,~]=cellfun(@fileparts,images,'UniformOutput',false);
    [~,labelNames,~]=cellfun(@fileparts,labels,'UniformOutput',false);
    imageNames=strrep(imageNames,suffixImage,'');
    labelNames=strrep(labelNames,suffixLabel,'');
    [~,imgIdx,lblIdx]=intersect(imageNames,labelNames);
    syncedImages=images(imgIdx);
    syncedLabels=labels(lblIdx);
end

function imgRGB=ensureRGB(img)
    if size(img,3)==1
        imgRGB=repmat(img,[1 1 3]);
    else
        imgRGB=img;
    end
end
